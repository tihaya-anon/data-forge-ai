# 任务管理工作流（优化为 Claude Code）

> 使用任务 DAG 规划 + Claude Code 单会话执行

## 概述

本项目使用结构化的任务管理方法：
- **任务清单** (`tasks.yaml`) - 集中定义所有任务及依赖关系
- **DAG 分析** - 自动计算并行度、关键路径
- **Claude Code 执行** - 在单个会话中按依赖顺序完成任务

## 目录结构

```
.ai-context/
├── CONTEXT.md              # 项目上下文
├── PARALLEL_DEV.md         # 本文档
├── tasks/
│   └── tasks.yaml          # 任务清单（核心文件）
└── scripts/
    └── task_dag.py         # DAG 分析脚本
```

## 快速开始

### 1. 查看任务概览

```bash
# 查看所有任务及状态
make task-list

# 查看任务完成进度
make task-status

# 查看下一个可执行的任务
make task-next
```

### 2. 分析任务结构

```bash
# 查看完整分析报告（并行度、关键路径）
make task-analyze

# 生成 DAG 可视化图
make task-dag
```

### 3. 执行任务

Claude Code 会：
1. 读取 `tasks.yaml` 了解任务结构
2. 按依赖顺序执行任务
3. 对于无依赖的任务，可使用 Task tool 并行执行
4. 更新任务状态到 `tasks.yaml`

---

## 任务清单格式

任务定义在 `.ai-context/tasks/tasks.yaml`：

```yaml
任务:
  - 编号: "T-001"           # 唯一标识
    名称: "Docker 基础配置"  # 简短描述
    工时: 2                  # 预估小时数
    依赖: []                 # 前置任务编号列表
    状态: "待处理"           # 待处理 | 进行中 | 已完成 | 已阻塞
    范围:                    # 允许修改的路径
      - "docker/"
    描述: |                  # 详细说明
      配置 Docker 网络、卷、基础存储服务
```

### 状态流转

```
待处理 → 进行中 → 已完成
           ↓
        已阻塞 → 进行中
```

---

## 命令参考

```bash
# === 任务查看 ===
make task-list         # 列出所有任务及状态
make task-next         # 显示下一个可执行的任务
make task-status       # 显示任务完成进度
make task-edit         # 编辑任务清单

# === DAG 分析 ===
make task-analyze      # 分析并行度和关键路径
make task-dag          # 生成 DAG 可视化图
```

---

## Claude Code 工作流

### 1. 开始新任务

```bash
# 查看下一个可执行的任务
make task-next
```

Claude Code 会看到类似输出：

```
============================================================
  下一个可执行的任务
============================================================

📋 T-001: Docker 基础配置
   工时: 2 小时
   状态: 待处理
   范围: docker/compose.base.yml, docker/compose.storage.yml
   描述: 配置 Docker 网络、卷、基础存储服务

📋 T-002: Makefile 框架搭建
   工时: 2 小时
   状态: 待处理
   范围: Makefile, makefiles/*.mk
   描述: 完善 Makefile 命令结构
```

### 2. 执行任务

Claude Code 会：
- 读取任务详情（范围、描述、依赖）
- 只修改任务范围内的文件
- 完成后更新 `tasks.yaml` 中的状态为 "已完成"

### 3. 并行执行（可选）

对于无依赖的任务（如 T-001、T-002、T-003），Claude Code 可以：
- 使用 Task tool 启动多个子 agent 并行工作
- 在同一个工作区完成所有任务
- 不需要 Git worktree

### 4. 提交代码

```bash
# Claude Code 会创建提交
git commit -m "[T-001] 完成 Docker 基础配置"
```

---

## DAG 分析详解

### 并行度指标

| 指标 | 说明 |
|------|------|
| **最大并行度** | 同时可执行的最多任务数 |
| **平均并行度** | 各层级并行度的平均值 |
| **加权平均** | 按工时加权的并行度 |

### 关键路径

关键路径是 DAG 中最长的路径，决定了项目最短完成时间。

```
关键路径: T-001 → T-004 → T-007 → T-009 → T-011
总工时: 26 小时
```

---

## 最佳实践

### 任务设计

- ✅ 每个任务 **2-8 小时**
- ✅ 明确的 **文件边界**（范围不重叠）
- ✅ 清晰的 **依赖关系**
- ❌ 避免多任务修改同一文件

### 依赖管理

1. **先定义接口** - 共享的类/函数先确定签名
2. **独立目录** - 每个任务对应独立目录
3. **避免全局修改** - 不要在并行任务中格式化/重构

---

## 与原工作流的区别

| 方面 | 原工作流（多 Agent） | 新工作流（Claude Code） |
|------|---------------------|------------------------|
| 执行模型 | 多个独立 AI 会话 | 单个持续会话 |
| 工作区 | Git worktree 多工作区 | 单个工作区 |
| 并行方式 | 物理隔离的目录 | Task tool 子 agent |
| 协调方式 | 通过 tasks.yaml 文件 | 会话内上下文 |
| 适用场景 | 多个独立 AI 工具 | Claude Code 专用 |

---

## 示例：完整工作流

```bash
# 1. 查看任务结构
make task-analyze
# 输出: 11 个任务，5 层，推荐 2 个并行度

# 2. 查看可执行任务
make task-next
# 输出: T-001, T-002, T-003 可以开始

# 3. Claude Code 开始工作
# - 读取 tasks.yaml
# - 按依赖顺序执行
# - 更新任务状态
# - 提交代码

# 4. 查看进度
make task-status
# 输出: 3/11 已完成 (27.3%)

# 5. 继续下一批任务
make task-next
# 输出: T-004, T-005, T-006 现在可以开始
```

---

## 提交规范

```bash
git commit -m "[T-004] 实现 Kafka Producer 基础结构"
git commit -m "[T-004] 添加重试机制"
git commit -m "[T-004] 完成单元测试"
```

---

## 常见问题

**Q: 为什么不使用 Git worktree？**
A: Claude Code 是单会话工具，不需要物理隔离的工作区。使用 Task tool 可以在同一工作区内实现并行。

**Q: 如何处理任务依赖？**
A: `make task-next` 会自动检查依赖，只显示前置任务已完成的任务。

**Q: 可以跳过某个任务吗？**
A: 可以，但需要手动更新 `tasks.yaml` 中的状态，或调整依赖关系。

**Q: 如何添加新任务？**
A: 编辑 `tasks.yaml`，添加新任务定义，运行 `make task-dag` 更新可视化图。
