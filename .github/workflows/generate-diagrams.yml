# GitHub Actions: Auto-generate diagrams from D2 source files
# Triggers on changes to docs/diagrams/*.d2 files

name: Generate Diagrams

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'docs/diagrams/**/*.d2'
      - 'docs/diagrams/*.d2'
  pull_request:
    branches:
      - main
      - master
    paths:
      - 'docs/diagrams/**/*.d2'
      - 'docs/diagrams/*.d2'
  # Allow manual trigger
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-diagrams:
    name: Generate D2 Diagrams
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Install D2
        run: |
          curl -fsSL https://d2lang.com/install.sh | sh -s --
          echo "$HOME/.d2/bin" >> $GITHUB_PATH
          
      - name: Verify D2 installation
        run: |
          d2 --version
          
      - name: Create images directory
        run: |
          mkdir -p docs/images
          
      - name: Generate SVG diagrams
        run: |
          echo "ðŸŽ¨ Generating diagrams..."
          for file in docs/diagrams/*.d2; do
            if [ -f "$file" ]; then
              filename=$(basename "$file" .d2)
              echo "  Generating: $filename.svg"
              d2 --theme 200 --layout elk --pad 20 "$file" "docs/images/$filename.svg"
            fi
          done
          echo "âœ… All diagrams generated!"
          
      - name: List generated files
        run: |
          echo "ðŸ“ Generated files:"
          ls -la docs/images/
          
      - name: Check for changes
        id: check_changes
        run: |
          git add docs/images/
          if git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes to commit"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ Changes detected"
          fi
          
      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true' && github.event_name == 'push'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git commit -m "chore: auto-generate diagrams from D2 sources

          ðŸ¤– This commit was automatically generated by GitHub Actions
          
          Updated diagrams:
          $(git diff --staged --name-only | sed 's/^/  - /')"
          git push
          
      - name: Create PR comment
        if: steps.check_changes.outputs.has_changes == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Get list of generated images
            const images = fs.readdirSync('docs/images')
              .filter(f => f.endsWith('.svg'))
              .map(f => `- \`${f}\``)
              .join('\n');
            
            const body = `## ðŸŽ¨ Diagram Preview
            
            The following diagrams have been generated/updated:
            
            ${images}
            
            > ðŸ’¡ These diagrams are auto-generated from \`docs/diagrams/*.d2\` source files.
            > The images will be committed automatically when this PR is merged.
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
            
      - name: Upload artifacts
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: generated-diagrams
          path: docs/images/*.svg
          retention-days: 7
