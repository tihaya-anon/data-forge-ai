# ===========================================
# DataForge AI - Compute Services
# ===========================================
# Apache Spark, Apache Flink

services:
  # -------------------------------------------
  # Apache Spark
  # -------------------------------------------
  spark-master:
    profiles: ["pipeline"]
    image: bitnami/spark:3.5
    container_name: dataforge-spark-master
    ports:
      - "7077:7077"
      - "8081:8081"
    environment:
      TZ: Asia/Shanghai
      SPARK_MODE: master
      SPARK_MASTER_HOST: spark-master
      SPARK_MASTER_PORT: 7077
      SPARK_MASTER_WEBUI_PORT: 8081
    networks:
      - dataforge
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  spark-worker:
    profiles: ["pipeline"]
    image: bitnami/spark:3.5
    container_name: dataforge-spark-worker
    environment:
      TZ: Asia/Shanghai
      SPARK_MODE: worker
      SPARK_MASTER_URL: spark://spark-master:7077
      SPARK_WORKER_MEMORY: 2G
      SPARK_WORKER_CORES: 2
    networks:
      - dataforge
    depends_on:
      spark-master:
        condition: service_healthy
    restart: unless-stopped

  # -------------------------------------------
  # Apache Flink
  # -------------------------------------------
  flink-jobmanager:
    profiles: ["pipeline"]
    image: flink:1.18-scala_2.12-java11
    container_name: dataforge-flink-jobmanager
    command: jobmanager
    ports:
      - "8082:8081"
    environment:
      TZ: Asia/Shanghai
      FLINK_PROPERTIES: |
        jobmanager.rpc.address: flink-jobmanager
        taskmanager.numberOfTaskSlots: 4
        parallelism.default: 2
    networks:
      - dataforge
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  flink-taskmanager:
    profiles: ["pipeline"]
    image: flink:1.18-scala_2.12-java11
    container_name: dataforge-flink-taskmanager
    command: taskmanager
    environment:
      TZ: Asia/Shanghai
      FLINK_PROPERTIES: |
        jobmanager.rpc.address: flink-jobmanager
        taskmanager.numberOfTaskSlots: 4
        taskmanager.memory.process.size: 2g
    networks:
      - dataforge
    depends_on:
      flink-jobmanager:
        condition: service_healthy
    restart: unless-stopped

networks:
  dataforge:
    external: true
