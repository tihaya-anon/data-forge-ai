# ===========================================
# DataForge AI - Storage Services
# ===========================================
# Kafka, MinIO, Milvus, Redis, Elasticsearch

services:
  # -------------------------------------------
  # Apache Kafka
  # -------------------------------------------
  kafka:
    profiles: ["minimal", "rag", "pipeline"]
    image: bitnami/kafka:3.6
    container_name: dataforge-kafka
    ports:
      - "9092:9092"
    environment:
      TZ: Asia/Shanghai
      KAFKA_CFG_NODE_ID: 1
      KAFKA_CFG_PROCESS_ROLES: controller,broker
      KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_CFG_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      KAFKA_CFG_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CFG_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE: "true"
    volumes:
      - kafka-data:/bitnami/kafka
    networks:
      - dataforge
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics.sh --bootstrap-server localhost:9092 --list"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  kafka-ui:
    profiles: ["minimal", "rag", "pipeline"]
    image: provectuslabs/kafka-ui:latest
    container_name: dataforge-kafka-ui
    ports:
      - "8080:8080"
    environment:
      TZ: Asia/Shanghai
      KAFKA_CLUSTERS_0_NAME: dataforge
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092
    networks:
      - dataforge
    depends_on:
      kafka:
        condition: service_healthy
    restart: unless-stopped

  # -------------------------------------------
  # MinIO (S3-compatible)
  # -------------------------------------------
  minio:
    profiles: ["rag", "pipeline"]
    image: minio/minio:latest
    container_name: dataforge-minio
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      TZ: Asia/Shanghai
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin123
    volumes:
      - minio-data:/data
    networks:
      - dataforge
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # -------------------------------------------
  # Milvus (Vector Database)
  # -------------------------------------------
  milvus-etcd:
    profiles: ["rag"]
    image: quay.io/coreos/etcd:v3.5.5
    container_name: dataforge-milvus-etcd
    command: etcd -advertise-client-urls=http://127.0.0.1:2379 -listen-client-urls=http://0.0.0.0:2379 --data-dir=/etcd
    environment:
      TZ: Asia/Shanghai
      ETCD_AUTO_COMPACTION_MODE: revision
      ETCD_AUTO_COMPACTION_RETENTION: "1000"
      ETCD_QUOTA_BACKEND_BYTES: "4294967296"
      ETCD_SNAPSHOT_COUNT: "50000"
    volumes:
      - milvus-etcd-data:/etcd
    networks:
      - dataforge
    healthcheck:
      test: ["CMD", "etcdctl", "endpoint", "health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  milvus:
    profiles: ["rag"]
    image: milvusdb/milvus:v2.3.4
    container_name: dataforge-milvus
    command: ["milvus", "run", "standalone"]
    ports:
      - "19530:19530"
      - "9091:9091"
    environment:
      TZ: Asia/Shanghai
      ETCD_ENDPOINTS: milvus-etcd:2379
      MINIO_ADDRESS: minio:9000
      MINIO_ACCESS_KEY_ID: minioadmin
      MINIO_SECRET_ACCESS_KEY: minioadmin123
    volumes:
      - milvus-data:/var/lib/milvus
    networks:
      - dataforge
    depends_on:
      milvus-etcd:
        condition: service_healthy
      minio:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9091/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # -------------------------------------------
  # Redis
  # -------------------------------------------
  redis:
    profiles: ["minimal", "rag", "pipeline"]
    image: redis:7-alpine
    container_name: dataforge-redis
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - dataforge
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  # -------------------------------------------
  # Elasticsearch
  # -------------------------------------------
  elasticsearch:
    profiles: ["rag"]
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: dataforge-elasticsearch
    ports:
      - "9200:9200"
    environment:
      TZ: Asia/Shanghai
      discovery.type: single-node
      xpack.security.enabled: "false"
      ES_JAVA_OPTS: "-Xms1g -Xmx1g"
    volumes:
      - es-data:/usr/share/elasticsearch/data
    networks:
      - dataforge
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:9200/_cluster/health | grep -q 'green\\|yellow'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

networks:
  dataforge:
    external: true

volumes:
  kafka-data:
    external: true
  minio-data:
    external: true
  milvus-etcd-data:
    external: true
  milvus-data:
    external: true
  redis-data:
    external: true
  es-data:
    external: true
