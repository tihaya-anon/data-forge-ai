# 数据流转全景图
# 展示实时流和批处理流的数据流转

direction: right

title: {
  label: 数据流转全景
  near: top-center
  shape: text
  style: {
    font-size: 24
    bold: true
    font-color: "#37474f"
  }
}

# 数据源
sources: "数据源" {
  style: {
    fill: "#f5f5f5"
    stroke: "#78909c"
    border-radius: 8
  }
  grid-columns: 3
  grid-gap: 10

  db: "数据库\nMySQL/PG/Mongo" {
    shape: cylinder
    style.fill: "#e8eaf6"
  }

  files: "文件\nS3/HDFS/NAS" {
    shape: document
    style.fill: "#e8eaf6"
  }

  api: "API\nREST/GraphQL" {
    shape: cloud
    style.fill: "#e8eaf6"
  }
}

# Kafka
kafka: "Apache Kafka" {
  shape: queue
  style: {
    fill: "#9fa8da"
    stroke: "#7986cb"
    bold: true
    font-size: 16
  }
}

# 实时流处理
realtime: "实时流" {
  style: {
    fill: "#f5f5f5"
    stroke: "#78909c"
    border-radius: 8
  }
  grid-columns: 4
  grid-gap: 10

  flink: "Apache Flink" {
    style: {
      fill: "#9fa8da"
      font-color: "#fff"
      bold: true
    }
  }

  parse: "解析与清洗" {
    style.fill: "#e8eaf6"
  }
  chunk: "分块" {
    style.fill: "#e8eaf6"
  }
  embed: "向量化" {
    style.fill: "#e8eaf6"
  }

  latency: {
    shape: text
    style: {
      font-size: 11
      italic: true
      font-color: "#616161"
    }
    label: "延迟: < 5秒"
  }

  flink -> parse -> chunk -> embed
}

# 批处理
batch: "批处理" {
  style: {
    fill: "#f5f5f5"
    stroke: "#78909c"
    border-radius: 8
  }
  grid-columns: 4
  grid-gap: 10

  spark: "Apache Spark" {
    style: {
      fill: "#9fa8da"
      font-color: "#fff"
      bold: true
    }
  }

  clean: "清洗与去重" {
    style.fill: "#e8eaf6"
  }
  quality: "质量过滤" {
    style.fill: "#e8eaf6"
  }
  embed: "批量向量化" {
    style.fill: "#e8eaf6"
  }

  throughput: {
    shape: text
    style: {
      font-size: 11
      italic: true
      font-color: "#616161"
    }
    label: "吞吐量: 50TB/天"
  }

  spark -> clean -> quality -> embed
}

# 数据湖
lake: "数据湖" {
  style: {
    fill: "#f5f5f5"
    stroke: "#78909c"
    border-radius: 8
  }
  grid-columns: 4
  grid-gap: 10

  paimon: "Apache Paimon" {
    shape: cylinder
    style: {
      fill: "#9fa8da"
      font-color: "#fff"
      bold: true
    }
  }

  training: "training_data" {
    style.fill: "#e8eaf6"
  }
  knowledge: "knowledge_docs" {
    style.fill: "#e8eaf6"
  }
  metadata: "metadata" {
    style.fill: "#e8eaf6"
  }

  features: {
    shape: text
    style: {
      font-size: 11
      font-color: "#616161"
    }
    label: "• 版本控制\n• 时间旅行\n• 增量更新"
  }
}

# 向量存储
vector: "向量存储" {
  style: {
    fill: "#f5f5f5"
    stroke: "#78909c"
    border-radius: 8
  }
  grid-columns: 3
  grid-gap: 10

  milvus: "Milvus" {
    shape: cylinder
    style: {
      fill: "#9fa8da"
      font-color: "#fff"
      bold: true
    }
  }

  index: "HNSW 索引" {
    style.fill: "#e8eaf6"
    label: "1亿+ 向量"
  }

  perf: {
    shape: text
    style: {
      font-size: 11
      font-color: "#616161"
    }
    label: "P99 < 50ms"
  }
}

# 应用
apps: "应用" {
  style: {
    fill: "#f5f5f5"
    stroke: "#78909c"
    border-radius: 8
  }
  grid-columns: 3
  grid-gap: 10

  rag: "RAG 服务" {
    style: {
      fill: "#c5cae9"
      font-color: "#000"
    }
  }

  train: "LLM 训练" {
    style: {
      fill: "#c5cae9"
      font-color: "#000"
    }
  }

  analytics: "数据分析" {
    style: {
      fill: "#c5cae9"
      font-color: "#000"
    }
  }
}

# 连接 - 实时流
sources.db -> kafka: CDC {
  style: {
    stroke: "#78909c"
    stroke-width: 2
  }
}

kafka -> realtime: 消费 {
  style: {
    stroke: "#78909c"
    stroke-width: 2
  }
}

realtime -> vector: 向量 {
  style: {
    stroke: "#78909c"
    stroke-width: 2
  }
}

realtime -> lake: 元数据 {
  style: {
    stroke: "#78909c"
    stroke-width: 2
  }
}

# 连接 - 批处理
sources.files -> batch: 加载 {
  style: {
    stroke: "#78909c"
    stroke-width: 2
    stroke-dash: 3
  }
}

kafka -> batch: 批量消费 {
  style: {
    stroke: "#78909c"
    stroke-width: 2
    stroke-dash: 3
  }
}

batch -> lake: 写入 {
  style: {
    stroke: "#78909c"
    stroke-width: 2
    stroke-dash: 3
  }
}

batch -> vector: 批量索引 {
  style: {
    stroke: "#78909c"
    stroke-width: 2
    stroke-dash: 3
  }
}

# 连接 - 应用
vector -> apps.rag {
  style.stroke: "#78909c"
}

lake -> apps.train {
  style.stroke: "#78909c"
}

lake -> apps.analytics {
  style.stroke: "#78909c"
}

# 图例
legend: "图例" {
  near: bottom-center
  style: {
    fill: "#fafafa"
    stroke: "#bdbdbd"
    border-radius: 4
  }

  items: {
    shape: text
    style.font-size: 11
    label: "── 实时流    - - 批处理流"
  }
}
