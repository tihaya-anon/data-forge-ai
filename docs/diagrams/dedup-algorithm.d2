# MinHash 去重算法流程
# 展示 MinHash + LSH 去重的详细步骤

grid-columns: 2
grid-gap: 20

classes: {
  stage: {
    style: {
      fill: "#f5f5f5"
      stroke: "#78909c"
      border-radius: 8
    }
  }
}

title: {
  label: MinHash 去重算法
  near: top-center
  shape: text
  style: {
    font-size: 24
    bold: true
    font-color: "#37474f"
  }
}

input-preprocess: "1. 输入与预处理" {
  class: stage
  grid-columns: 2
  grid-gap: 10

  input: "输入文档" {
    shape: document
    style: {
      fill: "#e8eaf6"
      stroke: "#9fa8da"
    }
    label: "10亿文档"
  }

  tokenize: "分词 jieba/nltk"
  stopword: "去停用词"
  ngram: "N-gram n=5"

  input -> tokenize -> stopword -> ngram
}

minhash: "2. MinHash 签名" {
  class: stage
  grid-columns: 1
  grid-gap: 10

  hash-funcs: "128 个哈希函数" {
    style.fill: "#e8eaf6"
    label: "h1, h2, ..., h128"
  }

  compute: "计算 MinHash" {
    style: {
      fill: "#c5cae9"
      font-color: "#000"
    }
    label: "对每个 h:\nmin(h(shingle))"
  }

  signature: "签名向量" {
    style: {
      fill: "#9fa8da"
      font-color: "#fff"
      bold: true
    }
    label: "[m1, m2, ..., m128]"
  }

  hash-funcs -> compute -> signature
}

lsh: "3. LSH 分桶" {
  class: stage
  grid-columns: 1
  grid-gap: 10

  config: "配置参数" {
    style.fill: "#e8eaf6"
    label: "32 bands × 4 rows = 128"
  }

  band: "分桶哈希" {
    style: {
      fill: "#c5cae9"
      font-color: "#000"
    }
    label: "hash(4 rows) → bucket_id"
  }

  buckets: "哈希桶" {
    style: {
      fill: "#9fa8da"
      font-color: "#fff"
      bold: true
    }
    label: "同桶 = 候选对"
  }

  config -> band -> buckets
}

verify: "4. 相似度验证" {
  class: stage
  grid-columns: 1
  grid-gap: 10

  pairs: "候选对" {
    style.fill: "#e8eaf6"
    label: "来自同一桶"
  }

  jaccard: "Jaccard 相似度" {
    style.fill: "#e8eaf6"
    label: "J(A,B) = |A∩B| / |A∪B|"
  }

  threshold: "阈值检查" {
    style: {
      fill: "#c5cae9"
      font-color: "#000"
      bold: true
    }
    label: "相似度 > 0.8 → 重复"
  }

  pairs -> jaccard -> threshold
}

cluster: "5. 聚类去重" {
  class: stage
  grid-columns: 1
  grid-gap: 10

  union-find: "Union-Find 算法" {
    style: {
      fill: "#c5cae9"
      font-color: "#000"
    }
    label: "合并所有重复文档"
  }

  select: "选择代表" {
    style: {
      fill: "#9fa8da"
      font-color: "#fff"
      bold: true
    }
    label: "每簇保留 1 个文档"
  }

  union-find -> select
}

output-tips: "6. 输出与优化" {
  class: stage
  grid-columns: 1
  grid-gap: 10

  output: "去重后文档" {
    shape: document
    style: {
      fill: "#7986cb"
      stroke: "#5c6bc0"
      bold: true
      font-color: "#fff"
    }
    label: "仅保留唯一文档"
  }

  tips: {
    shape: text
    style: {
      font-size: 11
      font-color: "#616161"
    }
    label: "Spark 优化: 分桶 | 广播 | 加盐\n10亿文档 4小时 | 精度 98%+"
  }
}

input-preprocess -> minhash {
  style: {
    stroke: "#78909c"
    stroke-width: 2
  }
}

minhash -> lsh {
  style: {
    stroke: "#78909c"
    stroke-width: 2
  }
}

lsh -> verify {
  style: {
    stroke: "#78909c"
    stroke-width: 2
  }
}

verify -> cluster {
  style: {
    stroke: "#78909c"
    stroke-width: 2
  }
}

cluster -> output-tips {
  style: {
    stroke: "#78909c"
    stroke-width: 2
  }
}
