# MinHash 去重算法流程
# 展示 MinHash + LSH 去重的详细步骤（正方形布局）

grid-columns: 2

title: {
  label: MinHash Deduplication Algorithm
  near: top-center
  shape: text
  style: {
    font-size: 24
    bold: true
    font-color: "#2e7d32"
  }
}

# ==========================================
# 左上：输入 + 预处理
# ==========================================
input-preprocess: "1. Input & Preprocessing" {
  style: {
    fill: "#fff3e0"
    stroke: "#e65100"
    border-radius: 8
  }
  
  grid-columns: 2
  grid-gap: 0
  
  input: "Input Documents" {
    shape: document
    style: {
      fill: "#e3f2fd"
      stroke: "#1565c0"
    }
    label: "10B docs"
  }
  
  tokenize: "Tokenize" {
    style.fill: "#ffe0b2"
    label: "jieba / nltk"
  }
  
  stopword: "Stopwords" {
    style.fill: "#ffcc80"
    label: "Remove"
  }
  
  ngram: "N-gram" {
    style.fill: "#ffb74d"
    label: "n = 5"
  }
  
  input -> tokenize -> stopword -> ngram
}

# ==========================================
# 右上：MinHash 签名
# ==========================================
minhash: "2. MinHash Signature" {
  style: {
    fill: "#e8f5e9"
    stroke: "#2e7d32"
    border-radius: 8
  }
  
  grid-columns: 1
  grid-gap: 0
  
  hash-funcs: "128 Hash Functions" {
    style.fill: "#a5d6a7"
    label: "h1, h2, ..., h128"
  }
  
  compute: "Compute MinHash" {
    style: {
      fill: "#66bb6a"
      font-color: "#fff"
    }
    label: "For each h:\nmin(h(shingle))"
  }
  
  signature: "Signature Vector" {
    style: {
      fill: "#43a047"
      font-color: "#fff"
      bold: true
    }
    label: "[m1, m2, ..., m128]"
  }
  
  hash-funcs -> compute -> signature
}

# ==========================================
# 左中：LSH 分桶
# ==========================================
lsh: "3. LSH Banding" {
  style: {
    fill: "#e0f7fa"
    stroke: "#00838f"
    border-radius: 8
  }
  
  grid-columns: 1
  grid-gap: 0
  
  config: "Configuration" {
    style.fill: "#80deea"
    label: "32 bands × 4 rows = 128"
  }
  
  band: "Band Hashing" {
    style: {
      fill: "#26c6da"
      font-color: "#fff"
    }
    label: "hash(4 rows) → bucket_id"
  }
  
  buckets: "Hash Buckets" {
    style: {
      fill: "#00acc1"
      font-color: "#fff"
      bold: true
    }
    label: "Same bucket = candidates"
  }
  
  config -> band -> buckets
}

# ==========================================
# 右中：候选对 + 验证
# ==========================================
verify: "4. Verification" {
  style: {
    fill: "#fce4ec"
    stroke: "#c2185b"
    border-radius: 8
  }
  
  grid-columns: 1
  grid-gap: 0
  
  pairs: "Candidate Pairs" {
    style.fill: "#f8bbd9"
    label: "From same bucket"
  }
  
  jaccard: "Jaccard Similarity" {
    style.fill: "#f48fb1"
    label: "J(A,B) = |A∩B| / |A∪B|"
  }
  
  threshold: "Threshold Check" {
    style: {
      fill: "#ec407a"
      font-color: "#fff"
      bold: true
    }
    label: "sim > 0.8 → Duplicate!"
  }
  
  pairs -> jaccard -> threshold
}

# ==========================================
# 左下：聚类
# ==========================================
cluster: "5. Clustering" {
  style: {
    fill: "#fff8e1"
    stroke: "#f9a825"
    border-radius: 8
  }
  
  grid-columns: 1
  grid-gap: 0
  
  union-find: "Union-Find" {
    style: {
      fill: "#ffca28"
      font-color: "#000"
    }
    label: "Group all duplicates"
  }
  
  select: "Select Representative" {
    style: {
      fill: "#ffa000"
      font-color: "#fff"
      bold: true
    }
    label: "Keep 1 doc per cluster"
  }
  
  union-find -> select
}

# ==========================================
# 右下：输出 + 优化
# ==========================================
output-tips: "6. Output & Optimizations" {
  style: {
    fill: "#e8eaf6"
    stroke: "#3f51b5"
    border-radius: 8
  }
  
  grid-columns: 1
  grid-gap: 0
  
  output: "Deduplicated Docs" {
    shape: document
    style: {
      fill: "#c8e6c9"
      stroke: "#2e7d32"
      bold: true
    }
    label: "Unique docs only"
  }
  
  tips: "Spark Optimizations" {
    style: {
      fill: "#ffebee"
      stroke: "#c62828"
    }
    label: "Bucketing | Broadcast | Salting\n10B docs in 4h | Precision 98%+"
  }
}

# ==========================================
# 连接
# ==========================================
input-preprocess -> minhash {
  style.stroke: "#e65100"
  style.stroke-width: 2
}

minhash -> lsh {
  style.stroke: "#2e7d32"
  style.stroke-width: 2
}

lsh -> verify {
  style.stroke: "#00838f"
  style.stroke-width: 2
}

verify -> cluster {
  style.stroke: "#c2185b"
  style.stroke-width: 2
}

cluster -> output-tips {
  style.stroke: "#f9a825"
  style.stroke-width: 2
}
