# RAG 智能知识库处理流程
# 展示从数据接入到智能问答的完整链路（正方形布局）

grid-columns: 2

title: {
  label: RAG Knowledge Base Pipeline
  near: top-center
  shape: text
  style: {
    font-size: 24
    bold: true
    font-color: "#1565c0"
  }
}

# ==========================================
# 左上：数据源 + Kafka
# ==========================================
data-ingestion: "1. Data Ingestion" {
  style: {
    fill: "#e3f2fd"
    stroke: "#1565c0"
    border-radius: 8
  }
  
  grid-columns: 2
  grid-gap: 0
  
  confluence: Confluence {
    shape: document
    style.fill: "#90caf9"
  }
  git: Git Repos {
    shape: document
    style.fill: "#90caf9"
  }
  mysql: MySQL {
    shape: cylinder
    style.fill: "#64b5f6"
  }
  files: Files/PDF {
    shape: document
    style.fill: "#90caf9"
  }
  
  kafka: Kafka {
    shape: queue
    style: {
      fill: "#ffca28"
      stroke: "#f57f17"
      bold: true
    }
    width: 300
  }
  
  confluence -> kafka
  git -> kafka
  mysql -> kafka
  files -> kafka
}

# ==========================================
# 右上：双路处理
# ==========================================
processing: "2. Processing Layer" {
  style: {
    fill: "#f3e5f5"
    stroke: "#7b1fa2"
    border-radius: 8
  }
  
  grid-columns: 2
  grid-gap: 0
  
  realtime: "Flink Real-time" {
    style.fill: "#ce93d8"
    label: "Incremental\nLatency < 5s"
  }
  
  batch: "Spark Batch" {
    style.fill: "#ba68c8"
    label: "Full rebuild\nDaily"
  }
  
  parse: "Parse" {
    style.fill: "#e1bee7"
    label: "PDF/HTML"
  }
  clean: "Clean" {
    style.fill: "#e1bee7"
    label: "De-noise"
  }
  chunk: "Chunk" {
    style.fill: "#ce93d8"
    label: "512 tokens"
  }
  meta: "Metadata" {
    style.fill: "#e1bee7"
    label: "Extract"
  }
  
  realtime -> parse
  batch -> parse
  parse -> clean -> chunk -> meta
}

# ==========================================
# 左中：向量化 + 存储
# ==========================================
embedding-storage: "3. Embedding & Storage" {
  style: {
    fill: "#e8f5e9"
    stroke: "#2e7d32"
    border-radius: 8
  }
  
  grid-columns: 3
  grid-gap: 0
  
  bge: "BGE-large-zh" {
    style: {
      fill: "#66bb6a"
      font-color: "#fff"
    }
    label: "Chinese"
  }
  openai: "text-embed-3" {
    style.fill: "#81c784"
    label: "Multilingual"
  }
  config: "Config" {
    style.fill: "#a5d6a7"
    label: "Dim: 1024"
  }
  
  milvus: Milvus {
    shape: cylinder
    style: {
      fill: "#00acc1"
      font-color: "#fff"
      bold: true
    }
    label: "HNSW\n100M+ vec"
  }
  paimon: Paimon {
    shape: cylinder
    style: {
      fill: "#26a69a"
      font-color: "#fff"
    }
    label: "Metadata"
  }
  es: ES {
    shape: cylinder
    style: {
      fill: "#fdd835"
      font-color: "#000"
    }
    label: "BM25"
  }
  
  bge -> milvus
  openai -> milvus
}

# ==========================================
# 右中：检索服务
# ==========================================
retrieval: "4. Retrieval Service" {
  style: {
    fill: "#fce4ec"
    stroke: "#c2185b"
    border-radius: 8
  }
  
  grid-columns: 2
  grid-gap: 0
  
  intent: "Intent" {
    style.fill: "#f8bbd9"
    label: "Recognition"
  }
  hyde: "HyDE" {
    style.fill: "#ec407a"
    style.font-color: "#fff"
    label: "Rewrite"
  }
  
  vec: "Vector" {
    style.fill: "#f48fb1"
    label: "Top-50"
  }
  kw: "BM25" {
    style.fill: "#f48fb1"
    label: "Top-50"
  }
  
  rrf: "RRF Fusion" {
    style.fill: "#e91e63"
    style.font-color: "#fff"
    label: "Merge"
  }
  rerank: "Reranker" {
    style: {
      fill: "#880e4f"
      font-color: "#fff"
      bold: true
    }
    label: "Top-10"
  }
  
  intent -> hyde
  vec -> rrf
  kw -> rrf
  rrf -> rerank
}

# ==========================================
# 左下：LLM 生成
# ==========================================
generation: "5. LLM Generation" {
  style: {
    fill: "#ede7f6"
    stroke: "#512da8"
    border-radius: 8
  }
  
  grid-columns: 1
  grid-gap: 0
  
  context: "Context Assembly" {
    style.fill: "#d1c4e9"
    label: "Top-10 docs as context"
  }
  
  llm: "LLM" {
    style: {
      fill: "#7c4dff"
      font-color: "#fff"
      bold: true
    }
    label: "GPT-4 / Claude"
  }
  
  response: "Response" {
    style.fill: "#b39ddb"
    label: "Answer + Citations [1][2]"
  }
  
  context -> llm -> response
}

# ==========================================
# 右下：用户 + 指标
# ==========================================
user-metrics: "6. User & Metrics" {
  style: {
    fill: "#fff8e1"
    stroke: "#f9a825"
    border-radius: 8
  }
  
  grid-columns: 1
  grid-gap: 0
  
  user: User {
    shape: person
    style: {
      fill: "#ffecb3"
      stroke: "#ff8f00"
    }
  }
  
  metrics: "Performance Metrics" {
    style.fill: "#fff59d"
    label: "Sync < 5s | Vector P99 < 50ms\nE2E < 500ms | Accuracy 90%+"
  }
}

# ==========================================
# 连接
# ==========================================
data-ingestion -> processing {
  style.stroke: "#1565c0"
  style.stroke-width: 2
}

processing -> embedding-storage {
  style.stroke: "#7b1fa2"
  style.stroke-width: 2
}

embedding-storage -> retrieval {
  style.stroke: "#2e7d32"
  style.stroke-width: 2
}

retrieval -> generation {
  style.stroke: "#c2185b"
  style.stroke-width: 2
}

user-metrics.user -> retrieval: Query {
  style.stroke: "#ff8f00"
  style.stroke-width: 2
}

generation -> user-metrics.user: Answer {
  style.stroke: "#512da8"
  style.stroke-width: 2
}
