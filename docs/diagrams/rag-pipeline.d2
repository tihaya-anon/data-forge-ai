# RAG 智能知识库处理流程
# 展示从数据接入到智能问答的完整链路

grid-columns: 2
grid-gap: 20

classes: {
  stage: {
    style: {
      fill: "#f5f5f5"
      stroke: "#78909c"
      border-radius: 8
    }
  }
}

title: {
  label: RAG 知识库处理流程
  near: top-center
  shape: text
  style: {
    font-size: 24
    bold: true
    font-color: "#37474f"
  }
}

data-ingestion: "1. 数据采集" {
  class: stage
  grid-columns: 2
  grid-gap: 10

  confluence: "Confluence" {
    shape: document
    style.fill: "#e8eaf6"
  }
  git: "Git Repos" {
    shape: document
    style.fill: "#e8eaf6"
  }
  mysql: "MySQL" {
    shape: cylinder
    style.fill: "#e8eaf6"
  }
  files: "Files/PDF" {
    shape: document
    style.fill: "#e8eaf6"
  }

  kafka: "Kafka" {
    shape: queue
    style: {
      fill: "#9fa8da"
      stroke: "#7986cb"
      bold: true
      font-color: "#fff"
    }
  }

  confluence -> kafka
  git -> kafka
  mysql -> kafka
  files -> kafka
}

processing: "2. 处理层" {
  class: stage
  grid-columns: 2
  grid-gap: 10

  realtime: "Flink 实时" {
    style.fill: "#c5cae9"
    label: "增量\n延迟 < 5s"
  }

  batch: "Spark 批处理" {
    style.fill: "#c5cae9"
    label: "全量重建\n每日"
  }

  parse: "解析 PDF/HTML"
  clean: "清洗 去噪"
  chunk: "分块 512 tokens"
  meta: "元数据提取"

  realtime -> parse
  batch -> parse
  parse -> clean -> chunk -> meta
}

embedding-storage: "3. 向量化与存储" {
  class: stage
  grid-columns: 3
  grid-gap: 10

  bge: "BGE-large-zh 中文" {
    style: {
      fill: "#9fa8da"
      font-color: "#fff"
    }
  }
  openai: "text-embed-3 多语言" {
    style.fill: "#e8eaf6"
  }
  config: "配置 Dim: 1024" {
    style.fill: "#e8eaf6"
  }

  milvus: "Milvus" {
    shape: cylinder
    style: {
      fill: "#c5cae9"
      font-color: "#000"
      bold: true
    }
    label: "HNSW\n100M+ vec"
  }
  paimon: "Paimon" {
    shape: cylinder
    style: {
      fill: "#c5cae9"
      font-color: "#000"
    }
    label: "元数据"
  }
  es: "ES" {
    shape: cylinder
    style: {
      fill: "#c5cae9"
      font-color: "#000"
    }
    label: "BM25"
  }

  bge -> milvus
  openai -> milvus
}

retrieval: "4. 检索服务" {
  class: stage
  grid-columns: 2
  grid-gap: 10

  intent: "意图识别"
  hyde: "HyDE 改写" {
    style: {
      fill: "#c5cae9"
      font-color: "#000"
    }
  }

  vec: "向量 Top-50"
  kw: "BM25 Top-50"

  rrf: "RRF 融合" {
    style: {
      fill: "#c5cae9"
      font-color: "#000"
    }
  }
  rerank: "重排器" {
    style: {
      fill: "#9fa8da"
      font-color: "#fff"
      bold: true
    }
    label: "Top-10"
  }

  intent -> hyde
  vec -> rrf
  kw -> rrf
  rrf -> rerank
}

generation: "5. LLM 生成" {
  class: stage
  grid-columns: 1
  grid-gap: 10

  context: "上下文组装" {
    style.fill: "#e8eaf6"
    label: "Top-10 文档作为上下文"
  }

  llm: "LLM" {
    style: {
      fill: "#9fa8da"
      font-color: "#fff"
      bold: true
    }
    label: "GPT-4 / Claude"
  }

  response: "响应" {
    style.fill: "#e8eaf6"
    label: "答案 + 引用 [1][2]"
  }

  context -> llm -> response
}

user-metrics: "6. 用户与指标" {
  class: stage
  grid-columns: 1
  grid-gap: 10

  user: "用户" {
    shape: person
    style: {
      fill: "#e8eaf6"
      stroke: "#9fa8da"
    }
  }

  metrics: {
    shape: text
    style: {
      font-size: 11
      font-color: "#616161"
    }
    label: "同步 < 5s | 向量 P99 < 50ms\nE2E < 500ms | 准确率 90%+"
  }
}

data-ingestion -> processing {
  style: {
    stroke: "#78909c"
    stroke-width: 2
  }
}

processing -> embedding-storage {
  style: {
    stroke: "#78909c"
    stroke-width: 2
  }
}

embedding-storage -> retrieval {
  style: {
    stroke: "#78909c"
    stroke-width: 2
  }
}

retrieval -> generation {
  style: {
    stroke: "#78909c"
    stroke-width: 2
  }
}

user-metrics.user -> retrieval: 查询 {
  style: {
    stroke: "#78909c"
    stroke-width: 2
  }
}

generation -> user-metrics.user: 答案 {
  style: {
    stroke: "#78909c"
    stroke-width: 2
  }
}
