# 混合检索策略流程
# 展示向量检索 + 关键词检索 + Rerank 的完整流程

grid-columns: 2
grid-gap: 20

title: {
  label: 混合检索策略
  near: top-center
  shape: text
  style: {
    font-size: 24
    bold: true
    font-color: "#37474f"
  }
}

# 左上：用户查询
user-query: "1. 用户查询" {
  style: {
    fill: "#f5f5f5"
    stroke: "#78909c"
    border-radius: 8
  }

  grid-columns: 1
  grid-gap: 10

  user: 用户 {
    shape: person
    style: {
      fill: "#e8eaf6"
      stroke: "#9fa8da"
    }
  }

  query: "查询" {
    shape: parallelogram
    style: {
      fill: "#c5cae9"
      stroke: "#9fa8da"
    }
    label: "如何配置 Flink CDC？"
  }

  user -> query
}

# 右上：查询处理
query-process: "2. 查询处理" {
  style: {
    fill: "#f5f5f5"
    stroke: "#78909c"
    border-radius: 8
  }

  grid-columns: 2
  grid-gap: 10

  intent: "意图识别" {
    style.fill: "#e8eaf6"
    label: "技术问答"
  }

  entity: "实体提取" {
    style.fill: "#e8eaf6"
    label: "Flink, CDC"
  }

  hyde: "HyDE 改写" {
    style: {
      fill: "#c5cae9"
      font-color: "#000"
      bold: true
    }
    label: "假设文档"
  }

  expand: "查询扩展" {
    style.fill: "#e8eaf6"
    label: "+ Debezium"
  }

  intent -> entity -> hyde -> expand
}

# 左中：向量检索
vector-search: "3. 向量检索" {
  style: {
    fill: "#f5f5f5"
    stroke: "#78909c"
    border-radius: 8
  }

  grid-columns: 1
  grid-gap: 10

  milvus: Milvus {
    shape: cylinder
    style: {
      fill: "#9fa8da"
      font-color: "#fff"
    }
  }

  hnsw: "HNSW 索引" {
    style.fill: "#e8eaf6"
    label: "ef = 128"
  }

  v-result: "向量结果" {
    style.fill: "#e8eaf6"
    label: "Top-50: [0.92, 0.89, 0.85...]"
  }

  milvus -> hnsw -> v-result
}

# 右中：关键词检索
keyword-search: "4. 关键词检索" {
  style: {
    fill: "#f5f5f5"
    stroke: "#78909c"
    border-radius: 8
  }

  grid-columns: 1
  grid-gap: 10

  es: Elasticsearch {
    shape: cylinder
    style: {
      fill: "#9fa8da"
      font-color: "#fff"
    }
  }

  bm25: "BM25 算法" {
    style.fill: "#e8eaf6"
    label: "基于 TF-IDF"
  }

  k-result: "关键词结果" {
    style.fill: "#e8eaf6"
    label: "Top-50: [12.5, 11.2, 10.8...]"
  }

  es -> bm25 -> k-result
}

# 左下：融合与重排
fusion-rerank: "5. 融合与重排" {
  style: {
    fill: "#f5f5f5"
    stroke: "#78909c"
    border-radius: 8
  }

  grid-columns: 2
  grid-gap: 10

  rrf: "RRF 融合" {
    style: {
      fill: "#c5cae9"
      font-color: "#000"
      bold: true
    }
    label: "Σ 1/(k+rank)"
  }

  merged: "合并结果" {
    style.fill: "#e8eaf6"
    label: "Top-100"
  }

  reranker: "BGE 重排器" {
    style: {
      fill: "#9fa8da"
      font-color: "#fff"
      bold: true
    }
    label: "Cross-Encoder"
  }

  final: "最终结果" {
    style: {
      fill: "#7986cb"
      font-color: "#fff"
      bold: true
    }
    label: "Top-10"
  }

  rrf -> merged -> reranker -> final
}

# 右下：LLM生成与性能
llm-perf: "6. LLM 生成与性能" {
  style: {
    fill: "#f5f5f5"
    stroke: "#78909c"
    border-radius: 8
  }

  grid-columns: 1
  grid-gap: 10

  generate: "LLM 生成" {
    style: {
      fill: "#9fa8da"
      font-color: "#fff"
      bold: true
    }
    label: "GPT-4 / Claude"
  }

  answer: "答案" {
    style.fill: "#e8eaf6"
    label: "带引用的回答 [1][2]"
  }

  perf: "性能对比" {
    style.fill: "#e8eaf6"
    label: "向量: 85%/20ms | 关键词: 75%/15ms\n混合: 92%/35ms | +重排: 95%/80ms"
  }

  generate -> answer
}

# 连接
user-query -> query-process {
  style.stroke: "#78909c"
  style.stroke-width: 2
}

query-process -> vector-search: 向量 {
  style.stroke: "#78909c"
  style.stroke-width: 2
}

query-process -> keyword-search: 关键词 {
  style.stroke: "#78909c"
  style.stroke-width: 2
}

vector-search -> fusion-rerank {
  style.stroke: "#78909c"
  style.stroke-width: 2
}

keyword-search -> fusion-rerank {
  style.stroke: "#78909c"
  style.stroke-width: 2
}

fusion-rerank -> llm-perf {
  style.stroke: "#78909c"
  style.stroke-width: 2
}

llm-perf.answer -> user-query.user: 响应 {
  style: {
    stroke: "#78909c"
    stroke-width: 2
  }
}
