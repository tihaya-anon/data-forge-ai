# 混合检索策略流程
# 展示向量检索 + 关键词检索 + Rerank 的完整流程（正方形布局）

grid-columns: 2

title: {
  label: Hybrid Retrieval Strategy
  near: top-center
  shape: text
  style: {
    font-size: 24
    bold: true
    font-color: "#c2185b"
  }
}

# ==========================================
# 左上：用户 + 查询
# ==========================================
user-query: "1. User Query" {
  style: {
    fill: "#fff8e1"
    stroke: "#f9a825"
    border-radius: 8
  }

  grid-columns: 1
  grid-gap: 0

  user: User {
    shape: person
    style: {
      fill: "#ffecb3"
      stroke: "#ff8f00"
    }
  }

  query: "Query" {
    shape: parallelogram
    style: {
      fill: "#ffe082"
      stroke: "#ffa000"
    }
    label: "How to configure Flink CDC?"
  }
  
  user -> query
}

# ==========================================
# 右上：查询处理
# ==========================================
query-process: "2. Query Processing" {
  style: {
    fill: "#e3f2fd"
    stroke: "#1565c0"
    border-radius: 8
  }
  
  grid-columns: 2
  grid-gap: 0
  
  intent: "Intent" {
    style.fill: "#90caf9"
    label: "Tech QA"
  }
  
  entity: "Entity" {
    style.fill: "#64b5f6"
    label: "Flink, CDC"
  }
  
  hyde: "HyDE" {
    style: {
      fill: "#1976d2"
      font-color: "#fff"
      bold: true
    }
    label: "Hypothetical\nDoc"
  }
  
  expand: "Expand" {
    style.fill: "#64b5f6"
    label: "+ Debezium"
  }
  
  intent -> entity -> hyde -> expand
}

# ==========================================
# 左中：向量检索
# ==========================================
vector-search: "3. Vector Search" {
  style: {
    fill: "#fce4ec"
    stroke: "#e91e63"
    border-radius: 8
  }

  grid-columns: 1
  grid-gap: 0

  milvus: Milvus {
    shape: cylinder
    style: {
      fill: "#00acc1"
      font-color: "#fff"
    }
  }

  hnsw: "HNSW Index" {
    style.fill: "#f48fb1"
    label: "ef = 128"
  }

  v-result: "Vector Results" {
    style.fill: "#f8bbd9"
    label: "Top-50: [0.92, 0.89, 0.85...]"
  }

  milvus -> hnsw -> v-result
}

# ==========================================
# 右中：关键词检索
# ==========================================
keyword-search: "4. Keyword Search" {
  style: {
    fill: "#fce4ec"
    stroke: "#f06292"
    border-radius: 8
  }

  grid-columns: 1
  grid-gap: 0

  es: Elasticsearch {
    shape: cylinder
    style: {
      fill: "#fdd835"
      font-color: "#000"
    }
  }

  bm25: "BM25 Algorithm" {
    style.fill: "#f8bbd9"
    label: "TF-IDF based"
  }

  k-result: "Keyword Results" {
    style.fill: "#f8bbd9"
    label: "Top-50: [12.5, 11.2, 10.8...]"
  }

  es -> bm25 -> k-result
}

# ==========================================
# 左下：融合 + Rerank
# ==========================================
fusion-rerank: "5. Fusion & Reranking" {
  style: {
    fill: "#ede7f6"
    stroke: "#512da8"
    border-radius: 8
  }

  grid-columns: 2
  grid-gap: 0

  rrf: "RRF Fusion" {
    style: {
      fill: "#7c4dff"
      font-color: "#fff"
      bold: true
    }
    label: "Σ 1/(k+rank)"
  }

  merged: "Merged" {
    style.fill: "#d1c4e9"
    label: "Top-100"
  }

  reranker: "BGE-Reranker" {
    style: {
      fill: "#43a047"
      font-color: "#fff"
      bold: true
    }
    label: "Cross-Encoder"
  }

  final: "Final" {
    style: {
      fill: "#2e7d32"
      font-color: "#fff"
      bold: true
    }
    label: "Top-10"
  }

  rrf -> merged -> reranker -> final
}

# ==========================================
# 右下：LLM生成 + 性能
# ==========================================
llm-perf: "6. LLM & Performance" {
  style: {
    fill: "#fff3e0"
    stroke: "#e65100"
    border-radius: 8
  }

  grid-columns: 1
  grid-gap: 0

  generate: "LLM Generate" {
    style: {
      fill: "#ff9800"
      font-color: "#fff"
      bold: true
    }
    label: "GPT-4 / Claude"
  }

  answer: "Answer" {
    style.fill: "#ffcc80"
    label: "Response with citations [1][2]"
  }

  perf: "Performance Comparison" {
    style.fill: "#ffecb3"
    label: "Vector: 85%/20ms | Keyword: 75%/15ms\nHybrid: 92%/35ms | +Rerank: 95%/80ms"
  }

  generate -> answer
}

# ==========================================
# 连接
# ==========================================
user-query -> query-process {
  style.stroke: "#f9a825"
  style.stroke-width: 2
}

query-process -> vector-search: Vector {
  style.stroke: "#c2185b"
  style.stroke-width: 2
}

query-process -> keyword-search: Keywords {
  style.stroke: "#c2185b"
  style.stroke-width: 2
}

vector-search -> fusion-rerank {
  style.stroke: "#512da8"
  style.stroke-width: 2
}

keyword-search -> fusion-rerank {
  style.stroke: "#512da8"
  style.stroke-width: 2
}

fusion-rerank -> llm-perf {
  style.stroke: "#2e7d32"
  style.stroke-width: 2
}

llm-perf.answer -> user-query.user: Response {
  style: {
    stroke: "#e65100"
    stroke-width: 2
  }
}
