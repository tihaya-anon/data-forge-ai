# LLM 训练数据处理 Pipeline
# 展示从原始数据到训练数据集的完整处理流程

grid-columns: 2
grid-gap: 20

classes: {
  stage: {
    style: {
      fill: "#f5f5f5"
      stroke: "#78909c"
      border-radius: 8
    }
  }
}

title: {
  label: LLM 训练数据处理流程
  near: top-center
  shape: text
  style: {
    font-size: 24
    bold: true
    font-color: "#37474f"
  }
}

raw-cleaning: "1. 原始数据与清洗" {
  class: stage
  grid-columns: 2
  grid-gap: 10

  raw: "原始数据" {
    shape: document
    style: {
      fill: "#e8eaf6"
      stroke: "#9fa8da"
    }
    label: "TB/PB 规模"
  }

  encoding: "编码规范化"
  html: "HTML 清理"
  special: "特殊字符过滤"
  lang: "语言检测"
  format: "格式标准化"

  raw -> encoding -> html -> special -> lang -> format
}

dedup: "2. 去重" {
  class: stage
  grid-columns: 3
  grid-gap: 10

  exact: "Hash 精确" {
    shape: hexagon
    style.fill: "#e8eaf6"
  }
  minhash: "MinHash 文档级" {
    shape: hexagon
    style: {
      fill: "#9fa8da"
      font-color: "#fff"
    }
  }
  simhash: "SimHash 段落级" {
    shape: hexagon
    style.fill: "#e8eaf6"
  }

  note: {
    shape: text
    style: {
      font-size: 11
      font-color: "#616161"
    }
    label: "10B 文档 4小时 | 阈值: 0.8"
  }

  exact -> minhash -> simhash
}

quality: "3. 质量过滤" {
  class: stage
  grid-columns: 2
  grid-gap: 10

  length: "长度 50-100K tok"
  dup-rate: "重复率 < 30%"
  special-rate: "特殊字符 < 20%"
  stopword: "停用词 > 10%"

  ppl: "困惑度 < 1000" {
    style: {
      fill: "#c5cae9"
      font-color: "#000"
    }
  }
  toxic: "毒性 < 0.7" {
    style: {
      fill: "#c5cae9"
      font-color: "#000"
    }
  }

  length -> special-rate -> ppl
  dup-rate -> stopword -> toxic
}

pii: "4. PII 与安全" {
  class: stage
  grid-columns: 1
  grid-gap: 10

  detect: "PII 检测" {
    style.fill: "#e8eaf6"
    label: "邮箱/电话/身份证/地址"
  }

  mask: "PII 脱敏" {
    style.fill: "#e8eaf6"
    label: "替换/哈希/匿名化"
  }

  filter: "敏感过滤" {
    style: {
      fill: "#c5cae9"
      font-color: "#000"
    }
    label: "黑名单/正则模式"
  }

  detect -> mask -> filter
}

augment: "5. 数据增强" {
  class: stage
  grid-columns: 2
  grid-gap: 10

  self-inst: "Self-Instruct 生成"
  evol-inst: "Evol-Instruct 演化"
  backtrans: "回译 多语言"
  paraphrase: "改写 重述"

  self-inst -> backtrans
  evol-inst -> paraphrase
}

mixing-output: "6. 配比与输出" {
  class: stage
  grid-columns: 5
  grid-gap: 8

  general: "通用 40%"
  code: "代码 25%"
  math: "数学 10%"
  instruct: "指令 15%"
  multi-lang: "多语言 10%"

  curriculum: "课程学习" {
    style: {
      fill: "#9fa8da"
      font-color: "#fff"
      bold: true
    }
    label: "难度递进"
  }

  output: "训练数据集" {
    shape: cylinder
    style: {
      fill: "#7986cb"
      font-color: "#fff"
      bold: true
    }
    label: "高质量数据"
  }

  general -> curriculum
  code -> curriculum
  math -> curriculum
  instruct -> curriculum
  multi-lang -> curriculum
  curriculum -> output
}

raw-cleaning -> dedup {
  style: {
    stroke: "#78909c"
    stroke-width: 2
  }
}

dedup -> quality {
  style: {
    stroke: "#78909c"
    stroke-width: 2
  }
}

quality -> pii {
  style: {
    stroke: "#78909c"
    stroke-width: 2
  }
}

pii -> augment {
  style: {
    stroke: "#78909c"
    stroke-width: 2
  }
}

augment -> mixing-output {
  style: {
    stroke: "#78909c"
    stroke-width: 2
  }
}

metrics: {
  shape: text
  near: bottom-center
  style: {
    font-size: 11
    italic: true
    font-color: "#616161"
  }
  label: "日处理 50TB+ | 去重 10B 文档 4小时 | 过滤率 ~30%"
}
