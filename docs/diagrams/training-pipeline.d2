# LLM 训练数据处理 Pipeline
# 展示从原始数据到训练数据集的完整处理流程

direction: down

title: {
  label: LLM Training Data Pipeline
  near: top-center
  shape: text
  style: {
    font-size: 24
    bold: true
    font-color: "#1565c0"
  }
}

# ==========================================
# Stage 1: 原始数据
# ==========================================
raw: Raw Data {
  shape: document
  style: {
    fill: "#e3f2fd"
    stroke: "#1565c0"
    font-size: 16
  }
  label: "Raw Data\n(TB/PB scale)"
}

# ==========================================
# Stage 2: 数据清洗
# ==========================================
cleaning: "Stage 1: Data Cleaning" {
  style: {
    fill: "#fff3e0"
    stroke: "#e65100"
    border-radius: 8
  }

  grid-columns: 5

  encoding: Encoding\nNormalization {
    style.fill: "#ffe0b2"
  }
  html: HTML Tag\nRemoval {
    style.fill: "#ffe0b2"
  }
  special: Special Char\nFiltering {
    style.fill: "#ffe0b2"
  }
  lang: Language\nDetection {
    style.fill: "#ffe0b2"
  }
  format: Format\nStandardization {
    style.fill: "#ffe0b2"
  }

  encoding -> html -> special -> lang -> format
}

# ==========================================
# Stage 3: 去重
# ==========================================
dedup: "Stage 2: Deduplication" {
  style: {
    fill: "#e8f5e9"
    stroke: "#2e7d32"
    border-radius: 8
  }

  exact: Exact Match\n(Hash) {
    shape: hexagon
    style.fill: "#a5d6a7"
  }

  minhash: MinHash\n(Document) {
    shape: hexagon
    style: {
      fill: "#66bb6a"
      font-color: "#fff"
    }
  }

  simhash: SimHash\n(Paragraph) {
    shape: hexagon
    style.fill: "#a5d6a7"
  }

  exact -> minhash -> simhash

  note: {
    shape: text
    style: {
      font-size: 12
      italic: true
    }
    label: "10B docs in 4 hours, Threshold: 0.8"
  }
}

# ==========================================
# Stage 4: 质量过滤
# ==========================================
quality: "Stage 3: Quality Filtering" {
  style: {
    fill: "#fce4ec"
    stroke: "#c2185b"
    border-radius: 8
  }

  rule-filters: Rule-based Filters {
    style: {
      fill: "#f8bbd9"
      border-radius: 4
    }

    grid-columns: 2

    length: "Length: 50-100K tokens"
    dup-rate: "Dup Rate: <30%"
    special-rate: "Special Char: <20%"
    stopword: "Stopword: >10%"
  }

  model-filters: Model-based Filters {
    style: {
      fill: "#f48fb1"
      border-radius: 4
    }

    grid-columns: 3

    ppl: "Perplexity\n(KenLM)\nPPL < 1000" {
      style.fill: "#ec407a"
      style.font-color: "#fff"
    }
    toxic: "Toxicity\nDetection\n< 0.7" {
      style.fill: "#ec407a"
      style.font-color: "#fff"
    }
    quality-score: "Quality\nClassifier\n> 0.5" {
      style.fill: "#ec407a"
      style.font-color: "#fff"
    }
  }

  rule-filters -> model-filters
}

# ==========================================
# Stage 5: PII 处理
# ==========================================
pii: "Stage 4: PII & Safety" {
  style: {
    fill: "#ede7f6"
    stroke: "#512da8"
    border-radius: 8
  }

  grid-columns: 3

  detect: PII Detection {
    style.fill: "#d1c4e9"
    label: "PII Detection\nEmail/Phone\nID Card/Address"
  }

  mask: PII Masking {
    style.fill: "#b39ddb"
    label: "PII Masking\nReplace/Hash\nAnonymize"
  }

  filter: Sensitive\nWord Filter {
    style.fill: "#d1c4e9"
    label: "Sensitive Filter\nBlacklist/Regex"
  }

  detect -> mask -> filter
}

# ==========================================
# Stage 6: 数据增强
# ==========================================
augment: "Stage 5: Augmentation & Synthesis" {
  style: {
    fill: "#e0f7fa"
    stroke: "#00838f"
    border-radius: 8
  }

  synthesis: Instruction Synthesis {
    style.fill: "#80deea"

    grid-columns: 2

    self-inst: Self-Instruct {
      style.fill: "#4dd0e1"
    }
    evol-inst: Evol-Instruct {
      style.fill: "#4dd0e1"
    }
  }

  augmentation: Data Augmentation {
    style.fill: "#80deea"

    grid-columns: 2

    backtrans: Back Translation {
      style.fill: "#26c6da"
    }
    paraphrase: Paraphrase {
      style.fill: "#26c6da"
    }
  }
}

# ==========================================
# Stage 7: 数据配比
# ==========================================
mixing: "Stage 6: Data Mixing" {
  style: {
    fill: "#fff8e1"
    stroke: "#f9a825"
    border-radius: 8
  }

  domains: Domain Distribution {
    style.fill: "#ffecb3"

    grid-columns: 5

    general: "General\n40%" {
      style: {
        fill: "#ffc107"
        font-color: "#000"
      }
    }
    code: "Code\n25%" {
      style: {
        fill: "#ffca28"
        font-color: "#000"
      }
    }
    math: "Math\n10%" {
      style: {
        fill: "#ffd54f"
        font-color: "#000"
      }
    }
    instruct: "Instruct\n15%" {
      style: {
        fill: "#ffe082"
        font-color: "#000"
      }
    }
    multi-lang: "Multi-lang\n10%" {
      style: {
        fill: "#ffecb3"
        font-color: "#000"
      }
    }
  }

  curriculum: Curriculum Learning {
    style: {
      fill: "#ffb300"
      font-color: "#fff"
      bold: true
    }
    label: "Curriculum Learning\n(Difficulty Progression)"
  }

  domains -> curriculum
}

# ==========================================
# Stage 8: 输出
# ==========================================
output: Training Dataset {
  shape: cylinder
  style: {
    fill: "#c8e6c9"
    stroke: "#2e7d32"
    font-size: 16
    bold: true
  }
  label: "High-Quality\nTraining Dataset\n(Paimon/Iceberg)"
}

# ==========================================
# 连接
# ==========================================
raw -> cleaning: Ingest {
  style.stroke: "#1565c0"
  style.stroke-width: 2
}

cleaning -> dedup: {
  style.stroke: "#e65100"
  style.stroke-width: 2
}

dedup -> quality: {
  style.stroke: "#2e7d32"
  style.stroke-width: 2
}

quality -> pii: {
  style.stroke: "#c2185b"
  style.stroke-width: 2
}

pii -> augment: {
  style.stroke: "#512da8"
  style.stroke-width: 2
}

augment -> mixing: {
  style.stroke: "#00838f"
  style.stroke-width: 2
}

mixing -> output: {
  style.stroke: "#f9a825"
  style.stroke-width: 2
}

# ==========================================
# 指标说明
# ==========================================
metrics: {
  shape: text
  near: bottom-center
  style: {
    font-size: 14
    italic: true
    font-color: "#616161"
  }
  label: "Performance: Daily 50TB+ | Dedup 10B docs in 4h | Filter rate ~30%"
}
