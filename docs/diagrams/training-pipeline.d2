# LLM 训练数据处理 Pipeline
# 展示从原始数据到训练数据集的完整处理流程（正方形布局）

grid-columns: 2

title: {
  label: LLM Training Data Pipeline
  near: top-center
  shape: text
  style: {
    font-size: 24
    bold: true
    font-color: "#1565c0"
  }
}

# ==========================================
# 左上：原始数据 + 清洗
# ==========================================
raw-cleaning: "1. Raw Data & Cleaning" {
  style: {
    fill: "#fff3e0"
    stroke: "#e65100"
    border-radius: 8
  }
  
  grid-columns: 2
  grid-gap: 0
  
  raw: Raw Data {
    shape: document
    style: {
      fill: "#e3f2fd"
      stroke: "#1565c0"
    }
    label: "TB/PB scale"
  }
  
  encoding: "Encoding" {
    style.fill: "#ffe0b2"
    label: "Normalize"
  }
  
  html: "HTML" {
    style.fill: "#ffcc80"
    label: "Remove tags"
  }
  
  special: "Special Char" {
    style.fill: "#ffb74d"
    label: "Filter"
  }
  
  lang: "Language" {
    style.fill: "#ffb74d"
    label: "Detect"
  }
  
  format: "Format" {
    style.fill: "#ffa726"
    label: "Standardize"
  }
  
  raw -> encoding -> html -> special -> lang -> format
}

# ==========================================
# 右上：去重
# ==========================================
dedup: "2. Deduplication" {
  style: {
    fill: "#e8f5e9"
    stroke: "#2e7d32"
    border-radius: 8
  }
  
  grid-columns: 3
  grid-gap: 0
  
  exact: "Hash" {
    shape: hexagon
    style.fill: "#a5d6a7"
    label: "Exact"
  }
  minhash: "MinHash" {
    shape: hexagon
    style: {
      fill: "#66bb6a"
      font-color: "#fff"
    }
    label: "Doc-level"
  }
  simhash: "SimHash" {
    shape: hexagon
    style.fill: "#a5d6a7"
    label: "Para-level"
  }
  
  note: "Performance" {
    style.fill: "#c8e6c9"
    label: "10B docs in 4h | Threshold: 0.8"
    width: 400
  }
  
  exact -> minhash -> simhash
}

# ==========================================
# 左中：质量过滤
# ==========================================
quality: "3. Quality Filtering" {
  style: {
    fill: "#fce4ec"
    stroke: "#c2185b"
    border-radius: 8
  }

  grid-columns: 2
  grid-gap: 0

  length: "Length" {
    style.fill: "#f8bbd9"
    label: "50-100K tok"
  }
  dup-rate: "Dup Rate" {
    style.fill: "#f8bbd9"
    label: "< 30%"
  }
  special-rate: "Special" {
    style.fill: "#f48fb1"
    label: "< 20%"
  }
  stopword: "Stopword" {
    style.fill: "#f48fb1"
    label: "> 10%"
  }
  
  ppl: "Perplexity" {
    style.fill: "#ec407a"
    style.font-color: "#fff"
    label: "PPL < 1000"
  }
  toxic: "Toxicity" {
    style.fill: "#ec407a"
    style.font-color: "#fff"
    label: "< 0.7"
  }
  
  length -> special-rate -> ppl
  dup-rate -> stopword -> toxic
}

# ==========================================
# 右中：PII处理
# ==========================================
pii: "4. PII & Safety" {
  style: {
    fill: "#ede7f6"
    stroke: "#512da8"
    border-radius: 8
  }
  
  grid-columns: 1
  grid-gap: 0
  
  detect: "PII Detection" {
    style.fill: "#d1c4e9"
    label: "Email / Phone / ID Card / Address"
  }

  mask: "PII Masking" {
    style.fill: "#b39ddb"
    label: "Replace / Hash / Anonymize"
  }

  filter: "Sensitive Filter" {
    style.fill: "#9575cd"
    style.font-color: "#fff"
    label: "Blacklist / Regex patterns"
  }

  detect -> mask -> filter
}

# ==========================================
# 左下：数据增强
# ==========================================
augment: "5. Augmentation" {
  style: {
    fill: "#e0f7fa"
    stroke: "#00838f"
    border-radius: 8
  }

  grid-columns: 2
  grid-gap: 0

  self-inst: "Self-Instruct" {
    style.fill: "#80deea"
    label: "Generate"
  }
  evol-inst: "Evol-Instruct" {
    style.fill: "#4dd0e1"
    label: "Evolve"
  }
  
  backtrans: "Back Translate" {
    style.fill: "#26c6da"
    label: "Multi-lang"
  }
  paraphrase: "Paraphrase" {
    style.fill: "#00bcd4"
    label: "Rephrase"
  }
  
  self-inst -> backtrans
  evol-inst -> paraphrase
}

# ==========================================
# 右下：配比 + 输出
# ==========================================
mixing-output: "6. Mixing & Output" {
  style: {
    fill: "#fff8e1"
    stroke: "#f9a825"
    border-radius: 8
  }

  grid-columns: 5
  grid-gap: 0

  general: "General" {
    style.fill: "#ffc107"
    label: "40%"
  }
  code: "Code" {
    style.fill: "#ffca28"
    label: "25%"
  }
  math: "Math" {
    style.fill: "#ffd54f"
    label: "10%"
  }
  instruct: "Instruct" {
    style.fill: "#ffe082"
    label: "15%"
  }
  multi-lang: "Multi" {
    style.fill: "#ffecb3"
    label: "10%"
  }

  curriculum: "Curriculum Learning" {
    style: {
      fill: "#ffb300"
      font-color: "#fff"
      bold: true
    }
    label: "Difficulty Progression"
    width: 400
  }

  output: Training Dataset {
    shape: cylinder
    style: {
      fill: "#c8e6c9"
      stroke: "#2e7d32"
      bold: true
    }
    label: "High-Quality Data"
    width: 400
  }

  general -> curriculum
  code -> curriculum
  math -> curriculum
  instruct -> curriculum
  multi-lang -> curriculum
  curriculum -> output
}

# ==========================================
# 连接
# ==========================================
raw-cleaning -> dedup {
  style.stroke: "#e65100"
  style.stroke-width: 2
}

dedup -> quality {
  style.stroke: "#2e7d32"
  style.stroke-width: 2
}

quality -> pii {
  style.stroke: "#c2185b"
  style.stroke-width: 2
}

pii -> augment {
  style.stroke: "#512da8"
  style.stroke-width: 2
}

augment -> mixing-output {
  style.stroke: "#00838f"
  style.stroke-width: 2
}

# ==========================================
# 指标说明
# ==========================================
metrics: {
  shape: text
  near: bottom-center
  style: {
    font-size: 12
    italic: true
    font-color: "#616161"
  }
  label: "Daily 50TB+ | Dedup 10B docs in 4h | Filter rate ~30%"
}
